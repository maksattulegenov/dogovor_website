# Medical Consent Form Website

Простой веб-сайт для сбора медицинского согласия с интеграцией Google Drive и webhook.

## Особенности

✅ 8 обязательных полей (ФИО, дата рождения, пол, ИИН, телефон, аллергия, процедуры, подпись)
✅ Адаптивный дизайн для мобильных устройств
✅ Валидация всех полей формы
✅ Рисование подписи на canvas
✅ Автоматическая загрузка подписи в Google Drive
✅ Отправка данных в n8n webhook

## Требования

- Node.js (версия 14 или выше)
- NPM или Yarn
- Google Cloud Project с включенным Google Drive API
- Credentials для Google Drive API

## Установка

1. Клонируйте репозиторий или распакуйте файлы в папку проекта

2. Установите зависимости:
```bash
npm install
```

## Настройка Google Drive API

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Drive API
4. Создайте OAuth 2.0 credentials
5. Добавьте `http://localhost:3000/oauth2callback` в список разрешенных redirect URIs
6. Credentials уже настроены в `server.js`

## Первый запуск и аутентификация

1. Запустите сервер:
```bash
npm start
```

2. Сервер выведет в консоль URL для аутентификации Google Drive:
```
⚠️  Google Drive not authenticated!
Visit this URL to authenticate:
https://accounts.google.com/o/oauth2/auth?...
```

3. Скопируйте URL и откройте его в браузере
4. Войдите в свой Google аккаунт и разрешите доступ
5. После успешной аутентификации токены будут сохранены в `tokens.json`
6. Перезапустите сервер

## Использование

1. Запустите сервер:
```bash
npm start
```

2. Откройте браузер и перейдите по адресу:
```
http://localhost:3000
```

3. Заполните форму:
   - **ФИО**: Полное имя
   - **Дата рождения**: Выберите дату
   - **Пол**: Выберите из списка
   - **ИИН**: Введите 12 цифр
   - **Телефон**: Формат +7XXXXXXXXXX или 8XXXXXXXXXX (10 цифр после кода)
   - **Аллергия**: Укажите аллергии или напишите "НЕТ"
   - **Процедуры**: Укажите нежелательные процедуры или напишите "НЕТ"
   - **Подпись**: Нарисуйте подпись на canvas

4. Нажмите кнопку "ЗАВЕРШИТЬ"

## Как это работает

1. **Валидация формы**: Все поля проверяются на корректность заполнения
2. **Загрузка подписи**: Подпись конвертируется в PNG и загружается в папку "signatures" на Google Drive с именем `{ИИН}.png`
3. **Отправка данных**: Данные формы (без изображения) отправляются на n8n webhook
4. **Успешное завершение**: Форма очищается и готова к следующему использованию

## Валидация полей

- **ФИО**: Обязательное поле
- **Дата рождения**: Обязательное поле
- **Пол**: Обязательное поле (выбор из списка)
- **ИИН**: Ровно 12 цифр
- **Телефон**: Должен начинаться с +7 или 8, затем 10 цифр
- **Аллергия**: Обязательное поле (можно написать "НЕТ")
- **Процедуры**: Обязательное поле (можно написать "НЕТ")
- **Подпись**: Должна быть нарисована на canvas

## Структура файлов

```
dogovor_website/
├── index.html          # Основная HTML страница
├── style.css           # Стили и адаптивный дизайн
├── script.js           # Клиентская логика (валидация, canvas, отправка)
├── server.js           # Node.js сервер для Google Drive API
├── package.json        # Зависимости проекта
├── tokens.json         # Токены Google OAuth (генерируется автоматически)
└── README.md           # Документация
```

## Настройка webhook

Webhook URL уже настроен в `script.js`:
```javascript
const WEBHOOK_URL = 'https://primary-production-7d413.up.railway.app/webhook-test/01658fd0-702f-4b0c-ac74-ee5806025f5b';
```

Формат отправляемых данных:
```json
{
  "fio": "Иванов Иван Иванович",
  "birthdate": "1990-01-01",
  "gender": "Мужской",
  "iin": "123456789012",
  "phone": "+71234567890",
  "allergy": "НЕТ",
  "procedures": "НЕТ"
}
```

## Разработка

Для разработки с автоматической перезагрузкой:
```bash
npm run dev
```

## Troubleshooting

### Ошибка "Google Drive not authenticated"
- Убедитесь, что вы прошли аутентификацию через URL, выведенный в консоль
- Проверьте, что файл `tokens.json` существует

### Ошибка валидации телефона
- Формат: +7XXXXXXXXXX (11 символов) или 8XXXXXXXXXX (11 символов)
- Пример: +71234567890 или 81234567890

### Подпись не загружается
- Убедитесь, что вы нарисовали подпись на canvas перед отправкой
- Проверьте консоль браузера на наличие ошибок

## Безопасность

⚠️ **Важно**: 
- Файл `tokens.json` содержит конфиденциальную информацию - добавьте его в `.gitignore`
- Не публикуйте credentials в открытых репозиториях
- Для production используйте переменные окружения

## Лицензия

MIT
